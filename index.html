<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Cloud Speaking (Dhamma Scriptwriter Edition)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; box-sizing: border-box; }
        h1 { background: #1f1f1f; color: #8ab4f8; padding: 15px; text-align: center; border-radius: 8px; margin-top: 0; font-size: 24px; border: 1px solid #333;}
        .section { background: #1e1e1e; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #333;}
        .row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        .row label { font-weight: bold; min-width: 140px; color: #b3b3b3; }
        
        input[type="text"], input[type="number"], select, textarea { 
            padding: 10px; border: 1px solid #444; border-radius: 4px; flex-grow: 1; 
            font-family: inherit; background-color: #2d2d2d; color: #ffffff; 
        }
        textarea { width: 100%; resize: vertical; box-sizing: border-box; font-size: 16px; line-height: 1.6; }
        
        input[type="range"] { flex-grow: 1; accent-color: #8ab4f8; cursor: pointer; }
        .val-display { background: #333; padding: 5px 10px; border-radius: 4px; font-family: monospace; font-weight: bold; min-width: 60px; text-align: center; color: #8ab4f8;}

        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s; background: #444; color: #e0e0e0; }
        button:hover:not(:disabled) { filter: brightness(1.2); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-primary { background: #8ab4f8; color: #121212; }
        .btn-success { background: #81c995; color: #121212; }
        .btn-danger { background: #f28b82; color: #121212; }
        .btn-warning { background: #f6aea9; color: #121212; }
        
        .status-box { background: #202124; color: #a8c7fa; padding: 10px; border-radius: 4px; border: 1px solid #444; font-family: monospace; white-space: pre-wrap; max-height: 150px; overflow-y: auto; }
        input[type="file"] { display: none; }
        audio { filter: invert(0.9) hue-rotate(180deg); width: 100%; }
        .char-count { margin-left: auto; color: #8ab4f8; font-family: monospace; font-size: 14px; font-weight: bold; background: #2d2d2d; padding: 5px 10px; border-radius: 4px; border: 1px solid #444;}
    </style>
</head>
<body>

    <h1>üéôÔ∏è Dhamma Scriptwriter & Speaking</h1>

    <div class="section">
        <h3 style="color: #fff;">üîë API Key & Model Management</h3>
        <div class="row">
            <label>Text Reasoning Model:</label>
            <select id="geminiModel">
                <option value="gemini-3-flash-preview" selected>Gemini 3 Flash Preview (Default)</option>
                        <option value="gemini-flash-latest">Gemini Flash Latest</option>
                        <option value="gemini-flash-lite-latest">Gemini Flash Lite Latest</option>
                        <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                        <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
                        <option value="gemini-3.1-pro-preview">Gemini 3.1 Pro Preview</option>
            </select>
        </div>
        <div class="row">
            <label>Google AI Studio Key:</label>
            <input type="text" id="geminiKey" placeholder="Required for AI Refiner">
            <button onclick="saveKey('geminiKey')">Save</button>
        </div>
        <div class="row">
            <label>Google Cloud TTS Key:</label>
            <input type="text" id="cloudKey" placeholder="Required for Audio">
            <button onclick="saveKey('cloudKey')">Save</button>
        </div>
    </div>

    <div class="section" style="border: 1px solid #f6aea9;">
        <h3 style="color: #f6aea9;">ü§ñ AI Text Refiner (Dhamma Scriptwriter)</h3>
        <p style="color: #888; font-size: 14px; margin-top: 0;">‡πÄ‡∏Å‡∏•‡∏≤‡∏ö‡∏ó‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ò‡∏£‡∏£‡∏°‡∏∞ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Journey ‡∏û‡∏π‡∏î‡∏ä‡πâ‡∏≤‡∏•‡∏á)</p>
        
        <div class="row">
            <label>Dhamma Style:</label>
            <select id="promptPresetSelect" onchange="loadPreset()" style="flex-grow: 2; border-color: #f6aea9;">
                <option value="dhamma_general" selected>üßò‚Äç‚ôÇÔ∏è ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏ò‡∏£‡∏£‡∏° ( meditative & reflective )</option>
                <option value="dhamma_explain">üìñ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏∞ ( Clear & Profound )</option>
                <option value="dhamma_metta">üíó ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏ï‡∏ï‡∏≤ ( Warm, Soft & Kind )</option>
                <option value="dhamma_solitude">üçÉ ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏á‡∏ö‡∏ß‡∏¥‡πÄ‡∏ß‡∏Å ( Quiet, Sparse & Very Slow )</option>
                <option value="grammar">‚úçÔ∏è ‡πÄ‡∏Å‡∏•‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ( Standard English )</option>
            </select>
        </div>

        <div class="row">
            <textarea id="voicePrompt" rows="3" style="font-size: 14px; border-color: #555;"></textarea>
        </div>

        <div class="row">
            <input type="file" id="fileRefiner" accept=".txt" onchange="openRefinerFile(event)">
            <button onclick="document.getElementById('fileRefiner').click()">Open (.txt)</button>
            <button onclick="saveRefinerFile()">Save</button>
            <button onclick="copyElement('draftScript')">Copy</button>
            <button class="btn-danger" onclick="clearElement('draftScript')">Clear</button>
            <button class="btn-primary" onclick="postToScript()" style="margin-left: auto;">üöÄ Post to Audio Script</button>
        </div>

        <textarea id="draftScript" rows="10" placeholder="‡∏ß‡∏≤‡∏á‡∏ö‡∏ó‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
        
        <div class="row" style="margin-top: 10px;">
            <button class="btn-warning" id="btnRefine" onclick="refineText()" style="width: 100%; font-size: 18px;">‚ú® Refine & Meditate Script (Gemini AI)</button>
        </div>
    </div>

    <div class="section">
        <h3 style="color: #fff;">üìù Final Audio Script (Auto-SSML)</h3>
        <div class="row">
            <input type="file" id="fileScript" accept=".txt" onchange="openFile(event, 'audioScript')">
            <button onclick="document.getElementById('fileScript').click()">Open (.txt)</button>
            <button onclick="saveFile('audioScript', 'My_Dhamma_Script.txt')">Save Script</button>
            <button onclick="copyElement('audioScript')">Copy</button>
            <button class="btn-danger" onclick="clearElement('audioScript')">Clear</button>
            <span class="char-count" id="countScript">0 Chars</span>
        </div>
        <textarea id="audioScript" rows="12" placeholder="‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏•‡∏≤‡∏à‡∏∞‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥..."></textarea>
    </div>

    <div class="section">
        <h3 style="color: #fff;">üéõÔ∏è Processing Controls & Sliders</h3>
        
        <div class="row">
            <label>Voice Model:</label>
            <select id="ttsVoice">
                <optgroup label="Journey (Natural - Best for Dhamma Emotion)">
                    <option value="en-US-Journey-D" selected>en-US-Journey-D (Male)</option>
                    <option value="en-US-Journey-F">en-US-Journey-F (Female)</option>
                </optgroup>
                <optgroup label="Neural2 (High Quality - Pitch Adjustable)">
                    <option value="en-US-Neural2-J">en-US-Neural2-J (Male - Deep)</option>
                    <option value="en-US-Neural2-I">en-US-Neural2-I (Male - Calm)</option>
                </optgroup>
                <optgroup label="Studio (High Quality - Fixed Pitch)">
                    <option value="en-US-Studio-Q">en-US-Studio-Q (Male - Studio)</option>
                </optgroup>
            </select>
            <label>Format:</label>
            <select id="audioFormat">
                <option value="MP3" selected>MP3</option>
                <option value="LINEAR16">WAV</option>
            </select>
        </div>

        <div class="row">
            <label>Prosody Rate:</label>
            <input type="range" id="ttsRate" min="20" max="200" value="80" oninput="updateSlider('ttsRate', 'rateVal', '%')">
            <span class="val-display" id="rateVal">80%</span>
        </div>
        <div class="row">
            <label>Prosody Pitch:</label>
            <input type="range" id="ttsPitch" min="-25" max="25" value="0" oninput="updateSlider('ttsPitch', 'pitchVal', '%')">
            <span class="val-display" id="pitchVal">0%</span>
        </div>
        <div class="row">
            <label>Volume Gain:</label>
            <input type="range" id="ttsVolume" min="-10" max="10" step="0.5" value="0" oninput="updateSlider('ttsVolume', 'volVal', ' dB')">
            <span class="val-display" id="volVal">0 dB</span>
        </div>

        <div class="row" style="margin-top: 20px;">
            <button class="btn-primary" onclick="previewAudio()">‚ñ∂Ô∏è Preview Audio</button>
            <button class="btn-success" onclick="startGeneration()">üöÄ Generate Full Audio</button>
            <button class="btn-danger" onclick="stopProcess()">‚èπÔ∏è Stop</button>
        </div>
        
        <div id="statusLog" class="status-box" style="margin-top: 10px;">Ready.</div>
        <audio id="audioPlayer" controls style="margin-top: 10px;"></audio>
        <button class="btn-success" id="downloadBtn" onclick="downloadAudio()" disabled style="width: 100%; margin-top: 10px;">üíæ Download Audio</button>
    </div>

    <script>
        let isProcessing = false;
        let audioChunksBlob = []; 

        const promptPresets = {
            "dhamma_general": "Rewrite the following text for a meditative Buddhist Dhamma narration. Use profound and empathetic English. IMPORTANT: To slow down the AI and add 'soul', insert commas (,) more frequently for natural pauses, and use ellipses (...) at the end of key insights to make the voice draw out and soften. Output ONLY the refined plain text.",
            "dhamma_explain": "Rewrite as a clear, wise Dhamma explanation. Break complex ideas into shorter, reflective sentences. Use commas (,) to separate logical steps and ellipses (...) to end sections, encouraging a thoughtful pace. Output ONLY plain text.",
            "dhamma_metta": "Rewrite for a Loving-Kindness (Metta) meditation tone. Use warm, soft, and gentle language. Insert many commas (,) and ellipses (...) specifically after words like 'love', 'peace', and 'kindness' to force the AI to elongate those sounds beautifully. Output ONLY plain text.",
            "dhamma_solitude": "Rewrite to evoke a sense of quiet solitude and inner peace. Use minimal but powerful words. Place ellipses (...) frequently between phrases to create long, meditative silences. The pace must feel very slow and still. Output ONLY plain text.",
            "grammar": "Correct the grammar and punctuation to be natural and professional. Output ONLY the refined plain text."
        };

        function loadPreset() {
            const selectEl = document.getElementById('promptPresetSelect');
            if (selectEl) {
                const selected = selectEl.value;
                document.getElementById('voicePrompt').value = promptPresets[selected] || "";
            }
        }

        function updateSlider(sliderId, displayId, suffix) {
            let val = document.getElementById(sliderId).value;
            if (val > 0 && (suffix === '%' || suffix === ' dB')) val = '+' + val;
            document.getElementById(displayId).innerText = val + suffix;
        }
        
        // Use DOMContentLoaded to ensure elements are ready
        document.addEventListener('DOMContentLoaded', () => {
            loadKey('geminiKey');
            loadKey('cloudKey');
            loadKey('geminiModel');
            updateCharCount('audioScript', 'countScript');
            loadPreset(); 
        });

        document.getElementById('audioScript').addEventListener('input', () => updateCharCount('audioScript', 'countScript'));

        function saveKey(id) {
            const val = document.getElementById(id).value.trim();
            if(val) { localStorage.setItem(id, val); alert('Settings Saved.'); }
        }
        function loadKey(id) {
            const val = localStorage.getItem(id);
            if(val) document.getElementById(id).value = val;
        }
        function copyElement(id) {
            const el = document.getElementById(id);
            navigator.clipboard.writeText(el.value).then(() => alert('Copied to clipboard.'));
        }
        function clearElement(id) {
            document.getElementById(id).value = '';
            if(id === 'audioScript') updateCharCount(id, 'countScript');
        }
        function logStatus(msg) {
            const box = document.getElementById('statusLog');
            box.innerText += `\n[${new Date().toLocaleTimeString()}] ${msg}`;
            box.scrollTop = box.scrollHeight;
        }

        // --- Refiner Helper Functions ---
        function openRefinerFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const target = document.getElementById('draftScript');
                const textToInsert = e.target.result;
                const startPos = target.selectionStart;
                const endPos = target.selectionEnd;
                target.value = target.value.substring(0, startPos) + textToInsert + target.value.substring(endPos, target.value.length);
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

        function saveRefinerFile() {
            const text = document.getElementById('draftScript').value;
            if(!text) return alert("Nothing to save!");
            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "AI_Text_Refiner.txt"; a.click();
            URL.revokeObjectURL(url);
        }

        function postToScript() {
            const content = document.getElementById('draftScript').value;
            if(!content.trim()) return alert("Draft is empty!");
            document.getElementById('audioScript').value = content;
            updateCharCount('audioScript', 'countScript');
            alert("Posted to Final Audio Script! (Overwritten)");
        }

        async function refineText() {
            const key = document.getElementById('geminiKey').value.trim();
            if(!key) return alert('Enter Gemini API key.');
            const script = document.getElementById('draftScript').value.trim();
            if(!script) return alert('Draft script is empty.');
            
            const btn = document.getElementById('btnRefine');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Meditating on Text...';
            btn.disabled = true;

            const model = document.getElementById('geminiModel').value;
            const instruction = document.getElementById('voicePrompt').value;
            const fullPrompt = `System instructions: ${instruction}\n\nText to refine:\n${script}`;

            logStatus(`Connecting to Gemini (${model})...`);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });
                
                if (!response.ok) {
                    const errBody = await response.json();
                    throw new Error(errBody.error ? errBody.error.message : `HTTP Error ${response.status}`);
                }

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("No response generated. Check your model access or API key.");
                }
                
                let resultText = data.candidates[0].content.parts[0].text.trim();
                // Clean markdown if AI adds it
                resultText = resultText.replace(/^```[a-z]*\n/i, '').replace(/\n```$/i, '');

                document.getElementById('audioScript').value = resultText;
                updateCharCount('audioScript', 'countScript');
                logStatus("Refinement complete. Results moved to Final Audio Script.");
                alert("Refined successfully and moved to Final Script!");
            } catch (err) {
                logStatus(`Gemini Error: ${err.message}`);
                alert(`Refinement failed: ${err.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- TTS Logic ---
        function openFile(event, targetId) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(targetId).value += e.target.result;
                updateCharCount(targetId, 'countScript');
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

        function saveFile(sourceId, filename) {
            const text = document.getElementById(sourceId).value;
            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        async function fetchTTS(rawTextChunk) {
            const voiceName = document.getElementById('ttsVoice').value;
            const key = document.getElementById('cloudKey').value.trim();
            const format = document.getElementById('audioFormat').value;
            
            const rateStr = document.getElementById('ttsRate').value + "%";
            const pitchValue = document.getElementById('ttsPitch').value;
            const pitchStr = (pitchValue >= 0 ? "+" : "") + pitchValue + "%";
            const volumeDb = parseFloat(document.getElementById('ttsVolume').value);

            let payload = {
                voice: { languageCode: "en-US", name: voiceName },
                audioConfig: { audioEncoding: format, volumeGainDb: volumeDb }
            };

            let cleanText = rawTextChunk.replace(/<[^>]+>/g, '').trim();

            if (voiceName.includes('Journey')) {
                payload.input = { text: cleanText };
            } else if (voiceName.includes('Studio')) {
                payload.input = { ssml: `<speak><prosody rate="${rateStr}">${cleanText}</prosody></speak>` };
            } else {
                payload.input = { ssml: `<speak><prosody rate="${rateStr}" pitch="${pitchStr}">${cleanText}</prosody></speak>` };
            }

            const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            return data.audioContent;
        }

        function chunkText(text, maxChars) {
            let chunks = [];
            let segments = text.split(/(?<=\.|\?|\!|\n)\s+/); 
            let current = "";
            for(let seg of segments) {
                if((current.length + seg.length) > maxChars) {
                    chunks.push(current.trim());
                    current = seg + " ";
                } else {
                    current += seg + " ";
                }
            }
            if(current) chunks.push(current.trim());
            return chunks;
        }

        async function previewAudio() {
            let text = document.getElementById('audioScript').value;
            if(!text.trim()) return;
            logStatus("Previewing...");
            try {
                let segments = text.split(/(?<=\.|\?|\!|\n)\s+/);
                let previewText = segments.slice(0, 3).join(' ');
                const audioBase64 = await fetchTTS(previewText);
                const format = document.getElementById('audioFormat').value === 'MP3' ? 'audio/mpeg' : 'audio/wav';
                const audioBlob = new Blob([base64ToUint8Array(audioBase64)], { type: format });
                document.getElementById('audioPlayer').src = URL.createObjectURL(audioBlob);
                document.getElementById('audioPlayer').play();
            } catch(e) { logStatus("Error: " + e.message); }
        }

        async function startGeneration() {
            let text = document.getElementById('audioScript').value;
            if(!text.trim()) return;
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const batchDelay = parseFloat(document.getElementById('batchDelay').value) * 1000;
            const format = document.getElementById('audioFormat').value === 'MP3' ? 'audio/mpeg' : 'audio/wav';

            const chunks = chunkText(text, batchSize);
            isProcessing = true;
            audioChunksBlob = [];
            logStatus(`Generating ${chunks.length} batches...`);

            for(let i=0; i<chunks.length; i++) {
                if(!isProcessing) break;
                logStatus(`Batch ${i+1}/${chunks.length}...`);
                try {
                    const audioBase64 = await fetchTTS(chunks[i]);
                    audioChunksBlob.push(base64ToUint8Array(audioBase64));
                    if(i < chunks.length-1) await new Promise(r => setTimeout(r, batchDelay + Math.random()*1000));
                } catch(e) { logStatus(`Error: ${e.message}`); isProcessing = false; break; }
            }
            if(audioChunksBlob.length) compileAudio(format);
        }

        function stopProcess() { isProcessing = false; logStatus("Stopped."); }
        function base64ToUint8Array(b64) {
            const bin = window.atob(b64);
            const bytes = new Uint8Array(bin.length);
            for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
            return bytes;
        }
        function compileAudio(mime) {
            const blob = new Blob(audioChunksBlob, { type: mime });
            const url = URL.createObjectURL(blob);
            document.getElementById('audioPlayer').src = url;
            const dBtn = document.getElementById('downloadBtn');
            dBtn.onclick = () => {
                const a = document.createElement("a");
                a.href = url; a.download = `Dhamma_Audio_${Date.now()}.${mime === 'audio/mpeg' ? 'mp3' : 'wav'}`;
                a.click();
            };
            dBtn.disabled = false;
            logStatus("‚úÖ Complete!");
        }
        function updateCharCount(inputId, displayId) {
            const textLength = document.getElementById(inputId).value.length;
            document.getElementById(displayId).innerText = `${textLength.toLocaleString()} Chars`;
        }
    </script>
</body>
</html>