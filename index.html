<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Cloud Speaking (Ultimate Studio Version)</title>
    <style>
        /* Dark Theme UI Design */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; box-sizing: border-box; }
        h1 { background: #1f1f1f; color: #8ab4f8; padding: 15px; text-align: center; border-radius: 8px; margin-top: 0; font-size: 24px; border: 1px solid #333;}
        .section { background: #1e1e1e; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #333;}
        .row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        .row label { font-weight: bold; min-width: 130px; color: #b3b3b3; }
        
        /* Form Elements Dark Mode */
        input[type="text"], input[type="number"], select, textarea { 
            padding: 10px; border: 1px solid #444; border-radius: 4px; flex-grow: 1; 
            font-family: inherit; background-color: #2d2d2d; color: #ffffff; 
        }
        input::placeholder, textarea::placeholder { color: #888; }
        textarea { width: 100%; resize: vertical; box-sizing: border-box; font-size: 16px; line-height: 1.6; }
        
        /* Sliders */
        input[type="range"] { flex-grow: 1; accent-color: #8ab4f8; cursor: pointer; }
        .val-display { background: #333; padding: 5px 10px; border-radius: 4px; font-family: monospace; font-weight: bold; min-width: 60px; text-align: center; color: #8ab4f8;}

        /* Buttons */
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s; background: #444; color: #e0e0e0; }
        button:hover:not(:disabled) { filter: brightness(1.2); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-primary { background: #8ab4f8; color: #121212; }
        .btn-success { background: #81c995; color: #121212; }
        .btn-danger { background: #f28b82; color: #121212; }
        .btn-warning { background: #f6aea9; color: #121212; }
        
        /* Status & Audio */
        .status-box { background: #202124; color: #a8c7fa; padding: 10px; border-radius: 4px; border: 1px solid #444; font-family: monospace; white-space: pre-wrap; max-height: 150px; overflow-y: auto; }
        input[type="file"] { display: none; }
        audio { filter: invert(0.9) hue-rotate(180deg); width: 100%; }

        /* Character Counter Style */
        .char-count { margin-left: auto; color: #8ab4f8; font-family: monospace; font-size: 14px; font-weight: bold; background: #2d2d2d; padding: 5px 10px; border-radius: 4px; border: 1px solid #444;}
    </style>
</head>
<body>

    <h1>üéôÔ∏è Google Cloud Speaking (Ultimate Studio)</h1>

    <div class="section">
        <h3 style="color: #fff;">üîë API Key Management</h3>
        <div class="row">
            <label>Google Cloud TTS:</label>
            <input type="text" id="cloudKey" placeholder="Required for Audio Generation">
            <button onclick="saveKey('cloudKey')">Save</button>
        </div>
        <div class="row">
            <label>Google AI Studio:</label>
            <input type="text" id="geminiKey" placeholder="Optional (Only needed if using AI Text Refiner)">
            <button onclick="saveKey('geminiKey')">Save</button>
        </div>
    </div>

    <div class="section">
        <h3 style="color: #fff;">üìù Final Audio Script (Auto-SSML)</h3>
        <p style="color: #888; margin-top: 0; font-size: 14px;">Paste your English text here. The system will automatically wrap it in SSML tags before generating audio.</p>
        <div class="row">
            <input type="file" id="fileScript" accept=".txt" onchange="openFile(event, 'audioScript')">
            <button onclick="document.getElementById('fileScript').click()">Open (.txt)</button>
            <button onclick="saveFile('audioScript', 'My_Audio_Script.txt')">Save Script</button>
            <button onclick="copyElement('audioScript')">Copy</button>
            <button class="btn-danger" onclick="clearElement('audioScript')">Clear</button>
            <span class="char-count" id="countScript">0 Chars</span>
        </div>
        <textarea id="audioScript" rows="12" placeholder="Example: Struggling with a chaotic mind? This isn't just ancient wisdom; it's the Buddha's precise path to inner peace."></textarea>
    </div>

    <div class="section">
        <h3 style="color: #fff;">üéõÔ∏è Processing Controls & Sliders</h3>
       
    <div>
        <h3 style="color: #fff;">‚öôÔ∏è Voice Selection</h3>
        <div class="row">
            <label>Voice Model:</label>
            <select id="ttsVoice">
                <optgroup label="Chirp 3: HD (Next-Gen AI - Highly Natural & Emotional)">
                    <option value="en-US-Chirp3-HD-Enceladus">en-US-Chirp3-HD-Enceladus (Male - Energetic/Promo)</option>
                    <option value="en-US-Chirp3-HD-Iapetus">en-US-Chirp3-HD-Iapetus (Male - Friendly/Casual)</option>
                    <option value="en-US-Chirp3-HD-Charon">en-US-Chirp3-HD-Charon (Male - Informative)</option>
                    <option value="en-US-Chirp3-HD-Puck">en-US-Chirp3-HD-Puck (Male - Upbeat)</option>
                    <option value="en-US-Chirp3-HD-Fenrir">en-US-Chirp3-HD-Fenrir (Male - Excitable)</option>
                    <option value="en-US-Chirp3-HD-Aoede">en-US-Chirp3-HD-Aoede (Female - Breezy)</option>
                    <option value="en-US-Chirp3-HD-Zephyr">en-US-Chirp3-HD-Zephyr (Female - Bright)</option>
                    <option value="en-US-Chirp3-HD-Kore">en-US-Chirp3-HD-Kore (Female - Firm)</option>
                </optgroup>
                <optgroup label="Neural2 (Recommended - High Quality & Pitch Adjustable)">
                    <option value="en-US-Neural2-J" selected>en-US-Neural2-J (Male - Deep/Authoritative)</option>
                    <option value="en-US-Neural2-I">en-US-Neural2-I (Male - Smooth/Calm)</option>
                    <option value="en-US-Neural2-D">en-US-Neural2-D (Male - Mature)</option>
                    <option value="en-US-Neural2-A">en-US-Neural2-A (Male - Standard)</option>
                    <option value="en-US-Neural2-C">en-US-Neural2-C (Female - Soft)</option>
                    <option value="en-US-Neural2-E">en-US-Neural2-E (Female - Articulate)</option>
                    <option value="en-US-Neural2-F">en-US-Neural2-F (Female - Bright)</option>
                    <option value="en-US-Neural2-G">en-US-Neural2-G (Female - Gentle)</option>
                    <option value="en-US-Neural2-H">en-US-Neural2-H (Female - Warm)</option>
                </optgroup>
                <optgroup label="Studio (High Quality - Fixed Pitch)">
                    <option value="en-US-Studio-Q">en-US-Studio-Q (Male - Studio Broadcast)</option>
                    <option value="en-US-Studio-O">en-US-Studio-O (Female - Studio Broadcast)</option>
                </optgroup>
                <optgroup label="Journey (Natural AI - No Prosody Allowed)">
                    <option value="en-US-Journey-D">en-US-Journey-D (Male - Natural)</option>
                    <option value="en-US-Journey-F">en-US-Journey-F (Female - Natural)</option>
                </optgroup>
            </select>
            <label>Format:</label>
            <select id="audioFormat">
                <option value="MP3" selected>MP3 (Best for long audio)</option>
                <option value="LINEAR16">WAV (High Quality)</option>
            </select>
        </div>
    </div>

        <div class="row">
            <label>Prosody Rate:</label>
            <input type="range" id="ttsRate" min="25" max="400" value="80" oninput="updateSlider('ttsRate', 'rateVal', '%')">
            <span class="val-display" id="rateVal">80%</span>
        </div>
        <div class="row">
            <label>Prosody Pitch:</label>
            <input type="range" id="ttsPitch" min="-20" max="20" value="5" oninput="updateSlider('ttsPitch', 'pitchVal', '%')">
            <span class="val-display" id="pitchVal">5%</span>
        </div>
        <div class="row">
            <label>Volume Gain:</label>
            <input type="range" id="ttsVolume" min="-10" max="10" step="0.5" value="0" oninput="updateSlider('ttsVolume', 'volVal', ' dB')">
            <span class="val-display" id="volVal">0 dB</span>
        </div>

        <div class="row" style="margin-top: 20px;">
            <label>Batch Size (Chars):</label>
            <input type="number" id="batchSize" value="3500">
            <label>Inter-batch Delay (Sec):</label>
            <input type="number" id="batchDelay" value="3" step="0.5">
        </div>
        
        <div class="row" style="margin-top: 15px;">
            <button class="btn-primary" onclick="previewAudio()">‚ñ∂Ô∏è Preview Audio (First chunk)</button>
            <button class="btn-success" onclick="startGeneration()">üöÄ Generate Full Audio</button>
            <button class="btn-danger" onclick="stopProcess()">‚èπÔ∏è Stop</button>
        </div>
        
        <h4 style="color: #fff; margin-bottom: 5px;">Status Log:</h4>
        <div id="statusLog" class="status-box">Ready.</div>

        <h4 style="color: #fff; margin-bottom: 5px;">Audio Output:</h4>
        <div class="row">
            <audio id="audioPlayer" controls></audio>
        </div>
        <div class="row">
            <button class="btn-success" id="downloadBtn" onclick="downloadAudio()" disabled>üíæ Download Audio</button>
        </div>
    </div>

    <div class="section" style="border-color: #555;">
        <h3 style="color: #fff;">ü§ñ AI Text Refiner (Optional: English Corrector)</h3>
        <p style="color: #888; font-size: 14px; margin-top: 0;">Use this section ONLY if you want Gemini to correct grammar or improve the tone of your text. It outputs plain text to be copied into the Audio Script above.</p>
        <div class="row">
            <select id="geminiModel">
                <option value="gemini-3-flash-preview" selected>Gemini 3 Flash Preview</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
            </select>
            <select id="promptPresetSelect" onchange="loadPreset()" style="flex-grow: 2;">
                <option value="dhamma">üßò‚Äç‚ôÇÔ∏è Improve Grammar & Apply Dhamma Tone</option>
                <option value="grammar">‚úçÔ∏è Just Correct Grammar</option>
            </select>
        </div>
        <div class="row">
            <textarea id="voicePrompt" rows="3"></textarea>
        </div>
        <div class="row">
            <textarea id="draftScript" rows="6" placeholder="Paste rough draft here..."></textarea>
        </div>
        <div class="row">
            <button class="btn-warning" id="btnRefine" onclick="refineText()">‚ú® Refine Text via Gemini</button>
        </div>
    </div>

    <script>
        let isProcessing = false;
        let audioChunksBlob = []; 

        const promptPresets = {
            "dhamma": "Rewrite the following text for a Buddhist Dhamma narration. Correct any grammatical errors. Make the English natural, flowing, and profound. The tone must be deep, calming, warm, empathetic, and trustworthy. DO NOT output any markdown, XML, or SSML tags. Output ONLY the refined plain text.",
            "grammar": "Correct the grammar and punctuation of the following English text. Make it sound natural for a native speaker. Output ONLY the refined plain text without any formatting or conversational filler."
        };

        function loadPreset() {
            document.getElementById('voicePrompt').value = promptPresets[document.getElementById('promptPresetSelect').value];
        }

        function updateSlider(sliderId, displayId, suffix) {
            let val = document.getElementById(sliderId).value;
            if (val > 0 && suffix === '%') val = '+' + val;
            if (val > 0 && suffix === ' dB') val = '+' + val;
            document.getElementById(displayId).innerText = val + suffix;
        }
        
        window.onload = () => {
            loadKey('geminiKey');
            loadKey('cloudKey');
            updateCharCount('audioScript', 'countScript');
            loadPreset(); 
        };

        document.getElementById('audioScript').addEventListener('input', () => updateCharCount('audioScript', 'countScript'));

        function updateCharCount(inputId, displayId) {
            const textLength = document.getElementById(inputId).value.length;
            document.getElementById(displayId).innerText = `${textLength.toLocaleString()} Chars`;